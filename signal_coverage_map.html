<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å—é€šå¸‚ä¿¡å·è¦†ç›–åœ°å›¾</title>
    <style>
        /* é¡µé¢æ•´ä½“æ ·å¼ */
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f8f9fa;
        }

        /* æ ‡é¢˜åŒºåŸŸ */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
        }

        .header p {
            margin: 8px 0 0 0;
            opacity: 0.9;
        }

        /* æ–‡ä»¶å¯¼å…¥é¢æ¿ */
        .import-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .file-input-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .file-input {
            flex: 1;
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .file-input:hover {
            border-color: #667eea;
        }

        .btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5a6fd8;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* ä¿¡æ¯é¢æ¿ */
        .info-panel {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* åœ°å›¾å®¹å™¨ */
        #map {
            width: 100%;
            height: 500px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* å›¾ä¾‹æ ·å¼ */
        .legend {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #dee2e6;
        }

        .legend h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .red { background-color: #dc3545; }
        .blue { background-color: #007bff; }
        .green { background-color: #28a745; }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .status-message {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="header">
        <h1>ğŸ—ºï¸ å—é€šå¸‚ä¿¡å·è¦†ç›–åœ°å›¾</h1>
        <p>å®æ—¶ç›‘æµ‹ç½‘ç»œä¿¡å·è´¨é‡åˆ†å¸ƒæƒ…å†µ</p>
    </div>

    <!-- Excelå¯¼å…¥é¢æ¿ -->
    <div class="import-panel">
        <h3>ğŸ“ Excelæ•°æ®å¯¼å…¥</h3>
        <div class="file-input-wrapper">
            <input type="file" id="excelFile" class="file-input" accept=".xlsx,.xls" />
            <button id="loadBtn" class="btn" onclick="loadExcelData()">åŠ è½½æ•°æ®</button>
            <button id="useDefaultBtn" class="btn" onclick="useDefaultData()">ä½¿ç”¨ç¤ºä¾‹æ•°æ®</button>
        </div>
        <div id="statusMessage"></div>
        <p><strong>Excelæ–‡ä»¶æ ¼å¼è¦æ±‚ï¼š</strong>åŒ…å«åˆ—ï¼šä½ç½®æè¿°ã€è¯¦ç»†åœ°å€ã€ç½‘ç»œç±»å‹ã€ä¿¡å·å¼ºåº¦ã€ä¸ŠæŠ¥æ—¶é—´ã€ä¸ŠæŠ¥äººã€å¤‡æ³¨</p>
    </div>

    <!-- ä¿¡æ¯é¢æ¿ -->
    <div class="info-panel">
        <h3>ğŸ“Š ç›‘æµ‹ç‚¹æ¦‚å†µ</h3>
        <p id="dataInfo">è¯·å¯¼å…¥Excelæ–‡ä»¶æˆ–ä½¿ç”¨ç¤ºä¾‹æ•°æ®</p>
    </div>

    <!-- åœ°å›¾å®¹å™¨ -->
    <div id="map"></div>

    <!-- å›¾ä¾‹è¯´æ˜ -->
    <div class="legend">
        <h4>ğŸ“¶ ä¿¡å·å¼ºåº¦å›¾ä¾‹</h4>
        <div class="legend-item">
            <div class="legend-dot red"></div>
            <span>ä¸¥é‡ç›²åŒº (1-2åˆ†) - ä¿¡å·æå·®ï¼Œéœ€è¦ä¼˜å…ˆå¤„ç†</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot blue"></div>
            <span>ä¿¡å·è¾ƒå·® (3-4åˆ†) - ä¿¡å·ä¸ç¨³å®šï¼Œå½±å“ä½¿ç”¨</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot green"></div>
            <span>ä¿¡å·è‰¯å¥½ (7-10åˆ†) - ä¿¡å·æ­£å¸¸</span>
        </div>
    </div>

    <!-- å¼•å…¥XLSXè§£æåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- é«˜å¾·åœ°å›¾API -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=d9f68330ebc73e4856581f67deac33a5"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let map = null;
        let markers = [];
        let currentData = [];

        // é»˜è®¤ç¤ºä¾‹æ•°æ®
        const DEFAULT_DATA = [
            {
                name: "å—é€šå¸‚å´‡å·åŒºå—å¤§è¡—",
                position: [120.86419, 32.012962],
                signal: 2,
                network: "5G",
                reporter: "å¼ ä¸‰",
                time: "2024-01-15 10:30",
                note: "åœ°ä¸‹å•†åœºä¿¡å·è¾ƒå¼±"
            },
            {
                name: "å—é€šç«è½¦ç«™",
                position: [120.860919, 32.004182],
                signal: 3,
                network: "5G", 
                reporter: "ææ˜",
                time: "2024-01-19 07:30",
                note: "å€™è½¦å…éƒ¨åˆ†åº§ä½åŒºä¿¡å·ä¸ä½³"
            },
            {
                name: "å—é€šå¤§å­¦é™„å±åŒ»é™¢",
                position: [120.865718, 32.008145],
                signal: 2,
                network: "4G",
                reporter: "é™ˆå", 
                time: "2024-01-19 10:15",
                note: "ä½é™¢éƒ¨ç”µæ¢¯é—´ä¿¡å·å¾ˆå·®"
            }
        ];

        // åœ°å›¾é…ç½®
        const MAP_CONFIG = {
            zoom: 14,
            center: [120.863, 32.008],
            viewMode: '2D'
        };

        /**
         * æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
         */
        function showMessage(message, type = 'success') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status-message ${type}">${message}</div>`;
            
            // 3ç§’åè‡ªåŠ¨æ¸…é™¤æ¶ˆæ¯
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        }

        /**
         * æ ¹æ®ä¿¡å·å¼ºåº¦è·å–å›¾æ ‡é¢œè‰²
         */
        function getIconColor(signal) {
            if (signal <= 2) return 'r';      // çº¢è‰² - ä¸¥é‡ç›²åŒº
            if (signal <= 4) return 'b';      // è“è‰² - ä¿¡å·è¾ƒå·®  
            if (signal <= 6) return 'y';      // é»„è‰² - ä¿¡å·ä¸€èˆ¬
            return 'g';                       // ç»¿è‰² - ä¿¡å·è‰¯å¥½
        }

        /**
         * åˆ›å»ºè‡ªå®šä¹‰æ ‡è®°å›¾æ ‡
         */
        function createMarkerIcon(color) {
            return new AMap.Icon({
                size: new AMap.Size(25, 34),
                image: `https://webapi.amap.com/theme/v1.3/markers/n/mark_${color}.png`
            });
        }

        /**
         * è·å–ä¿¡å·å¼ºåº¦æè¿°
         */
        function getSignalDescription(signal) {
            if (signal <= 2) return 'ä¸¥é‡ç›²åŒº';
            if (signal <= 4) return 'ä¿¡å·è¾ƒå·®';
            if (signal <= 6) return 'ä¿¡å·ä¸€èˆ¬';
            return 'ä¿¡å·è‰¯å¥½';
        }

        /**
         * åˆå§‹åŒ–åœ°å›¾
         */
        function initMap() {
            console.log('å¼€å§‹åˆå§‹åŒ–åœ°å›¾...');

            // æ£€æŸ¥é«˜å¾·åœ°å›¾APIæ˜¯å¦åŠ è½½æˆåŠŸ
            if (typeof AMap === 'undefined') {
                showMessage('âŒ é«˜å¾·åœ°å›¾APIåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼', 'error');
                return;
            }

            try {
                // åˆ›å»ºåœ°å›¾å®ä¾‹
                map = new AMap.Map('map', MAP_CONFIG);
                console.log('âœ… åœ°å›¾åˆ›å»ºæˆåŠŸ');

                // åœ°å›¾åŠ è½½å®Œæˆäº‹ä»¶
                map.on('complete', function() {
                    console.log('âœ… åœ°å›¾åŠ è½½å®Œæˆ');
                    showMessage('âœ… åœ°å›¾åˆå§‹åŒ–æˆåŠŸï¼Œè¯·å¯¼å…¥æ•°æ®æˆ–ä½¿ç”¨ç¤ºä¾‹æ•°æ®');
                });

            } catch (error) {
                console.error('âŒ åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
                showMessage(`âŒ åœ°å›¾åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        /**
         * æ¸…é™¤åœ°å›¾ä¸Šçš„æ‰€æœ‰æ ‡è®°
         */
        function clearMarkers() {
            if (markers.length > 0) {
                map.remove(markers);
                markers = [];
            }
        }

        /**
         * æ·»åŠ ä¿¡å·ç›‘æµ‹ç‚¹æ ‡è®°
         */
        function addSignalMarkers(data) {
            clearMarkers();
            
            data.forEach((point, index) => {
                const iconColor = getIconColor(point.signal);
                const icon = createMarkerIcon(iconColor);
                
                // åˆ›å»ºæ ‡è®°ç‚¹
                const marker = new AMap.Marker({
                    position: point.position,
                    title: `${point.name} - ä¿¡å·å¼ºåº¦: ${point.signal}/10 (${getSignalDescription(point.signal)})`,
                    icon: icon
                });

                // æ·»åŠ åˆ°åœ°å›¾å’Œæ ‡è®°æ•°ç»„
                map.add(marker);
                markers.push(marker);
                console.log(`âœ… å·²æ·»åŠ æ ‡è®°ç‚¹ ${index + 1}: ${point.name}`);
            });

            // æ›´æ–°ä¿¡æ¯é¢æ¿
            updateInfoPanel(data);
        }

        /**
         * æ›´æ–°ä¿¡æ¯é¢æ¿
         */
        function updateInfoPanel(data) {
            const totalPoints = data.length;
            const severeCount = data.filter(p => p.signal <= 2).length;
            const avgSignal = (data.reduce((sum, p) => sum + p.signal, 0) / totalPoints).toFixed(1);
            
            document.getElementById('dataInfo').innerHTML = `
                å½“å‰æ˜¾ç¤º <strong>${totalPoints}</strong> ä¸ªä¿¡å·ç›‘æµ‹ç‚¹ï¼Œ
                å…¶ä¸­ä¸¥é‡ç›²åŒº <strong>${severeCount}</strong> ä¸ªï¼Œ
                å¹³å‡ä¿¡å·å¼ºåº¦ <strong>${avgSignal}/10</strong>
            `;
        }

        /**
         * ä½¿ç”¨é»˜è®¤ç¤ºä¾‹æ•°æ®
         */
        function useDefaultData() {
            if (!map) {
                showMessage('âŒ è¯·å…ˆç­‰å¾…åœ°å›¾åŠ è½½å®Œæˆ', 'error');
                return;
            }

            currentData = DEFAULT_DATA;
            addSignalMarkers(currentData);
            showMessage('âœ… å·²åŠ è½½ç¤ºä¾‹æ•°æ®ï¼Œæ˜¾ç¤º3ä¸ªç›‘æµ‹ç‚¹');
        }

        /**
         * è§£æExcelæ–‡ä»¶
         */
        function parseExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                reader.readAsArrayBuffer(file);
            });
        }

        /**
         * å¤„ç†Excelæ•°æ®å¹¶è½¬æ¢ä¸ºåœ°å›¾æ ¼å¼
         */
        function processExcelData(excelData) {
            const processedData = [];
            
            excelData.forEach((row, index) => {
                // æ£€æŸ¥å¿…è¦å­—æ®µ
                if (!row['ä½ç½®æè¿°'] || !row['ä¿¡å·å¼ºåº¦']) {
                    console.warn(`è·³è¿‡ç¬¬${index + 1}è¡Œï¼šç¼ºå°‘å¿…è¦å­—æ®µ`);
                    return;
                }

                // è¿™é‡Œæš‚æ—¶ä½¿ç”¨ç¤ºä¾‹åæ ‡ï¼Œå®é™…åº”è¯¥è°ƒç”¨åœ°ç†ç¼–ç API
                // ä¸ºç®€åŒ–æ¼”ç¤ºï¼Œæˆ‘ä»¬ä½¿ç”¨å—é€šå‘¨è¾¹çš„éšæœºåæ ‡
                const basePosition = [120.863, 32.008];
                const randomOffset = () => (Math.random() - 0.5) * 0.1; // Â±0.05åº¦éšæœºåç§»
                
                const processed = {
                    name: row['ä½ç½®æè¿°'],
                    position: [
                        basePosition[0] + randomOffset(),
                        basePosition[1] + randomOffset()
                    ],
                    signal: parseInt(row['ä¿¡å·å¼ºåº¦']) || 5,
                    network: row['ç½‘ç»œç±»å‹'] || 'æœªçŸ¥',
                    reporter: row['ä¸ŠæŠ¥äºº'] || 'åŒ¿å',
                    time: row['ä¸ŠæŠ¥æ—¶é—´'] || 'æœªçŸ¥',
                    note: row['å¤‡æ³¨'] || 'æ— '
                };

                processedData.push(processed);
            });

            return processedData;
        }

        /**
         * åŠ è½½Excelæ•°æ®
         */
        async function loadExcelData() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('âŒ è¯·å…ˆé€‰æ‹©Excelæ–‡ä»¶', 'error');
                return;
            }

            if (!map) {
                showMessage('âŒ è¯·å…ˆç­‰å¾…åœ°å›¾åŠ è½½å®Œæˆ', 'error');
                return;
            }

            try {
                showMessage('ğŸ“Š æ­£åœ¨è§£æExcelæ–‡ä»¶...', 'info');
                
                // è§£æExcelæ–‡ä»¶
                const excelData = await parseExcelFile(file);
                console.log('Excelæ•°æ®:', excelData);

                // å¤„ç†æ•°æ®
                const processedData = processExcelData(excelData);
                
                if (processedData.length === 0) {
                    showMessage('âŒ æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ•°æ®è¡Œ', 'error');
                    return;
                }

                // æ›´æ–°å½“å‰æ•°æ®å¹¶æ˜¾ç¤ºåœ¨åœ°å›¾ä¸Š
                currentData = processedData;
                addSignalMarkers(currentData);
                
                showMessage(`âœ… æˆåŠŸå¯¼å…¥ ${processedData.length} æ¡æ•°æ®è®°å½•`);

            } catch (error) {
                console.error('Excelå¤„ç†é”™è¯¯:', error);
                showMessage(`âŒ Excelæ–‡ä»¶å¤„ç†å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–åœ°å›¾
        window.onload = function() {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            initMap();
        };
    </script>
</body>
</html> 