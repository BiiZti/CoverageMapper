<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>南通市信号覆盖地图</title>
    <style>
        /* 页面整体样式 */
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f8f9fa;
        }

        /* 标题区域 */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
        }

        .header p {
            margin: 8px 0 0 0;
            opacity: 0.9;
        }

        /* 控制面板样式 */
        .control-panel {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            cursor: pointer;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
            margin: 0;
            padding: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
            pointer-events: auto;
            user-select: none;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .intensity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .intensity-slider {
            width: 150px;
        }

        /* 文件导入面板 */
        .import-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .file-input-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .file-input {
            flex: 1;
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .file-input:hover {
            border-color: #667eea;
        }

        .btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5a6fd8;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* 信息面板 */
        .info-panel {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* 地图容器 */
        #map {
            width: 100%;
            height: 500px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* 图例样式 */
        .legend {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #dee2e6;
        }

        .legend h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .red { background-color: #ff0000; }
        .orange { background-color: #ff8800; }
        .green { background-color: #00bb00; }
        .blue { background-color: #0088ff; }

        /* 加载状态 */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .status-message {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <!-- 页面标题 -->
    <div class="header">
        <h1>🗺️ 南通市信号覆盖地图</h1>
        <p>实时监测网络信号质量分布情况</p>
    </div>

    <!-- Excel导入面板 -->
    <div class="import-panel">
        <h3>📁 Excel数据导入</h3>
        <div class="file-input-wrapper">
            <input type="file" id="excelFile" class="file-input" accept=".xlsx,.xls" />
            <button id="loadBtn" class="btn" onclick="loadExcelData()">加载数据</button>
            <button id="useDefaultBtn" class="btn" onclick="useDefaultData()">使用示例数据</button>
        </div>
        <div id="statusMessage"></div>
        <p><strong>Excel文件格式要求：</strong>包含列：位置描述、详细地址、网络类型、信号强度、上报时间、上报人、备注</p>
    </div>

    <!-- 信息面板 -->
    <div class="info-panel">
        <h3>📊 监测点概况</h3>
        <p id="dataInfo">请导入Excel文件或使用示例数据</p>
    </div>

    <!-- 地图容器 -->
    <div id="map"></div>

    <!-- 图例说明 -->
    <div class="legend">
        <h4>📶 信号强度图例</h4>
        <div class="legend-item">
            <div class="legend-dot red" style="width: 18px; height: 18px;"></div>
            <span>严重盲区 (1-2分) - 红色大标记，需要优先处理</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot red" style="width: 12px; height: 12px;"></div>
            <span>信号较差 (3-4分) - 红色小标记，信号不稳定</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot blue" style="width: 12px; height: 12px;"></div>
            <span>信号一般 (5-6分) - 蓝色小标记，信号可用</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot blue" style="width: 18px; height: 18px;"></div>
            <span>信号良好 (7-10分) - 蓝色大标记，信号稳定</span>
        </div>
    </div>

    <!-- 控制面板 -->
    <div class="control-panel">
        <h3>📋 控制面板</h3>
        <div class="control-group">
            <label>热力图显示</label>
            <label class="switch">
                <input type="checkbox" id="heatmapSwitch">
                <span class="slider"></span>
            </label>
        </div>
        <div class="control-group">
            <label>标记点显示</label>
            <label class="switch">
                <input type="checkbox" id="markersSwitch" checked>
                <span class="slider"></span>
            </label>
        </div>
        <div class="control-group">
            <label>信号强度范围 (显示≤该值的监测点)</label>
            <div class="intensity-control">
                <input type="range" id="intensitySlider" min="1" max="10" value="10">
                <span id="intensityValue">10</span>
            </div>
        </div>
    </div>

    <!-- 引入XLSX解析库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- 高德地图API -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=d9f68330ebc73e4856581f67deac33a5&plugin=AMap.HeatMap"></script>
    
    <script>
        // 全局变量
        let map = null;
        let markers = [];
        let currentData = [];
        let heatmapLayer = null;

        /**
         * 生成随机的南通市信号监测数据
         */
        function generateRandomData(count = 1000) {
            const data = [];
            
            // 南通市及周边更大区域范围 (经纬度边界)
            const bounds = {
                minLng: 120.400,  // 西边界 - 扩展到海安
                maxLng: 121.700,  // 东边界 - 扩展到启东
                minLat: 31.700,   // 南边界 - 扩展到海门南部
                maxLat: 32.600    // 北边界 - 扩展到如东北部
            };
            
            // 南通市各区县和主要地标
            const locations = [
                "崇川区", "港闸区", "通州区", "海门区", "启东市", "如东县", "海安市",
                "南通市中心", "南通火车站", "南通汽车站", "南通大学", "南通医院",
                "海门工业园", "启东港口", "如东风电场", "海安开发区", "通州湾",
                "狼山景区", "濠河公园", "森林野生动物园", "南通博物苑",
                "商场", "住宅区", "学校", "医院", "银行", "政府大楼", "社区服务中心",
                "乡镇", "农村", "高速公路", "国道", "县道", "乡道", "渔港", "码头"
            ];
            
            const networks = ["5G", "4G", "3G"];
            const reporters = ["张三", "李四", "王五", "赵六", "陈七", "刘八", "匿名用户"];
            
            // 重点监测区域中心点（某些区域监测点会更密集）
            const hotspots = [
                [120.863, 32.008],  // 南通市中心
                [121.177, 31.890],  // 海门区
                [121.657, 31.810],  // 启东市
                [120.737, 32.481],  // 如东县
                [120.462, 32.546],  // 海安市
                [121.073, 32.267],  // 通州区
                [120.885, 32.066]   // 港闸区
            ];
            
            for (let i = 0; i < count; i++) {
                let lng, lat;
                
                // 30%的概率在重点区域附近生成，70%在全域随机生成
                if (Math.random() < 0.3 && hotspots.length > 0) {
                    // 在重点区域附近生成
                    const hotspot = hotspots[Math.floor(Math.random() * hotspots.length)];
                    const radius = 0.05; // 重点区域半径约5公里
                    lng = hotspot[0] + (Math.random() - 0.5) * radius * 2;
                    lat = hotspot[1] + (Math.random() - 0.5) * radius * 2;
                } else {
                    // 在全域随机生成
                    lng = bounds.minLng + Math.random() * (bounds.maxLng - bounds.minLng);
                    lat = bounds.minLat + Math.random() * (bounds.maxLat - bounds.minLat);
                }
                
                // 根据位置调整信号强度分布
                let signal;
                const rand = Math.random();
                
                // 判断是否在重点区域附近（信号相对较好）
                const isNearHotspot = hotspots.some(hotspot => {
                    const distance = Math.sqrt(Math.pow(lng - hotspot[0], 2) + Math.pow(lat - hotspot[1], 2));
                    return distance < 0.08; // 8公里左右
                });
                
                if (isNearHotspot) {
                    // 城市区域：信号相对较好
                    if (rand < 0.05) signal = Math.floor(Math.random() * 2) + 1;      // 5% 严重盲区
                    else if (rand < 0.15) signal = Math.floor(Math.random() * 2) + 3; // 10% 信号较差  
                    else if (rand < 0.50) signal = Math.floor(Math.random() * 3) + 5; // 35% 信号一般
                    else signal = Math.floor(Math.random() * 3) + 8;                  // 50% 信号良好
                } else {
                    // 郊区/农村：信号相对较差
                    if (rand < 0.20) signal = Math.floor(Math.random() * 2) + 1;      // 20% 严重盲区
                    else if (rand < 0.50) signal = Math.floor(Math.random() * 2) + 3; // 30% 信号较差  
                    else if (rand < 0.85) signal = Math.floor(Math.random() * 3) + 5; // 35% 信号一般
                    else signal = Math.floor(Math.random() * 3) + 8;                  // 15% 信号良好
                }
                
                // 随机生成其他信息
                const location = locations[Math.floor(Math.random() * locations.length)];
                const network = networks[Math.floor(Math.random() * networks.length)];
                const reporter = reporters[Math.floor(Math.random() * reporters.length)];
                
                // 随机生成时间 (最近30天)
                const date = new Date();
                date.setDate(date.getDate() - Math.floor(Math.random() * 30));
                const timeStr = date.toISOString().slice(0, 16).replace('T', ' ');
                
                data.push({
                    name: `${location}监测点${i + 1}`,
                    position: [lng, lat],
                    signal: signal,
                    network: network,
                    reporter: reporter,
                    time: timeStr,
                    note: signal <= 2 ? "信号盲区需要重点关注" : 
                          signal <= 4 ? "信号较弱，建议优化" : 
                          signal <= 7 ? "信号正常" : "信号良好"
                });
            }
            
            console.log(`🎲 生成了${count}个随机监测点数据`);
            return data;
        }

        // 默认示例数据 (1000个随机点)
        const DEFAULT_DATA = generateRandomData(1000);

        // 地图配置
        const MAP_CONFIG = {
            zoom: 10,  // 降低缩放级别以显示更大区域
            center: [121.05, 32.15],  // 调整中心点到南通市几何中心
            viewMode: '2D'
        };

        /**
         * 显示状态消息
         */
        function showMessage(message, type = 'success') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status-message ${type}">${message}</div>`;
            
            // 3秒后自动清除消息
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        }

        /**
         * 根据信号强度获取图标颜色和大小
         * 只使用确实可用的颜色：r(红), b(蓝)，通过大小区分其他级别
         */
        function getIconConfig(signal) {
            if (signal <= 2) {
                return { color: 'r', size: 30, type: '严重盲区' };      // 红色大图标 - 严重盲区
            } else if (signal <= 4) {
                return { color: 'r', size: 20, type: '信号较差' };      // 红色小图标 - 信号较差
            } else if (signal <= 6) {
                return { color: 'b', size: 20, type: '信号一般' };      // 蓝色小图标 - 信号一般
            } else {
                return { color: 'b', size: 30, type: '信号良好' };      // 蓝色大图标 - 信号良好
            }
        }

        /**
         * 创建自定义标记图标
         */
        function createMarkerIcon(color, size = 25) {
            // 使用确实可用的v1.3主题图标
            const iconHeight = Math.round(size * 1.36); // 保持宽高比
            return new AMap.Icon({
                size: new AMap.Size(size, iconHeight),
                image: `https://webapi.amap.com/theme/v1.3/markers/n/mark_${color}.png`,
                imageSize: new AMap.Size(size, iconHeight)
            });
        }

        /**
         * 获取信号强度描述
         */
        function getSignalDescription(signal) {
            if (signal <= 2) return '严重盲区 🔴大';
            if (signal <= 4) return '信号较差 🔴小';
            if (signal <= 6) return '信号一般 🔵小';
            return '信号良好 🔵大';
        }

        /**
         * 初始化地图
         */
        function initMap() {
            console.log('开始初始化地图...');

            // 检查高德地图API是否加载成功
            if (typeof AMap === 'undefined') {
                showMessage('❌ 高德地图API加载失败，请检查网络连接！', 'error');
                return;
            }

            try {
                // 创建地图实例
                map = new AMap.Map('map', MAP_CONFIG);
                console.log('✅ 地图创建成功');

                // 地图加载完成事件
                map.on('complete', function() {
                    console.log('✅ 地图加载完成');
                    showMessage('✅ 地图初始化成功，请导入数据或使用示例数据');
                    
                    // 初始化控制面板事件
                    initControls();
                });

            } catch (error) {
                console.error('❌ 地图初始化失败:', error);
                showMessage(`❌ 地图初始化失败: ${error.message}`, 'error');
            }
        }

        /**
         * 清除地图上的所有标记
         */
        function clearMarkers() {
            if (markers.length > 0) {
                map.remove(markers);
                markers = [];
            }
        }

        /**
         * 添加信号监测点标记
         */
        function addSignalMarkers(data) {
            clearMarkers();
            
            // 如果数据量太大，进行采样显示以提高性能
            let displayData = data;
            const MAX_MARKERS = 200; // 最大显示200个标记点
            
            if (data.length > MAX_MARKERS) {
                console.log(`数据量过大(${data.length}个点)，采样显示${MAX_MARKERS}个代表性标记点`);
                
                // 按信号强度分层采样，确保各种信号强度都有代表
                const severeBlinds = data.filter(p => p.signal <= 2);
                const poor = data.filter(p => p.signal >= 3 && p.signal <= 4);
                const normal = data.filter(p => p.signal >= 5 && p.signal <= 6);
                const good = data.filter(p => p.signal >= 7);
                
                const sampleSize = Math.floor(MAX_MARKERS / 4);
                displayData = [
                    ...sampleArray(severeBlinds, sampleSize),
                    ...sampleArray(poor, sampleSize),
                    ...sampleArray(normal, sampleSize),
                    ...sampleArray(good, sampleSize)
                ];
                
                showMessage(`📍 采样显示${displayData.length}个代表性监测点，完整数据请查看热力图`, 'info');
            }
            
            displayData.forEach((point, index) => {
                const iconConfig = getIconConfig(point.signal);
                const icon = createMarkerIcon(iconConfig.color, iconConfig.size);
                
                // 创建标记点
                const marker = new AMap.Marker({
                    position: point.position,
                    title: `${point.name} - 信号强度: ${point.signal}/10 (${iconConfig.type})`,
                    icon: icon
                });

                // 添加到地图和标记数组
                map.add(marker);
                markers.push(marker);
            });

            console.log(`✅ 已添加${displayData.length}个标记点（总数据${data.length}个）`);

            // 更新信息面板（使用完整数据统计）
            updateInfoPanel(data);
            
            // 更新热力图
            updateHeatmap();
        }

        /**
         * 数组采样函数
         */
        function sampleArray(array, sampleSize) {
            if (array.length <= sampleSize) return array;
            
            const step = array.length / sampleSize;
            const sampled = [];
            
            for (let i = 0; i < sampleSize; i++) {
                const index = Math.floor(i * step);
                if (index < array.length) {
                    sampled.push(array[index]);
                }
            }
            
            return sampled;
        }

        /**
         * 更新信息面板
         */
        function updateInfoPanel(data) {
            const totalPoints = data.length;
            const severeCount = data.filter(p => p.signal <= 2).length;
            const avgSignal = (data.reduce((sum, p) => sum + p.signal, 0) / totalPoints).toFixed(1);
            
            document.getElementById('dataInfo').innerHTML = `
                当前显示 <strong>${totalPoints}</strong> 个信号监测点，
                其中严重盲区 <strong>${severeCount}</strong> 个，
                平均信号强度 <strong>${avgSignal}/10</strong>
            `;
        }

        /**
         * 使用默认示例数据
         */
        function useDefaultData() {
            if (!map) {
                showMessage('❌ 请先等待地图加载完成', 'error');
                return;
            }

            currentData = DEFAULT_DATA;
            addSignalMarkers(currentData);
            showMessage(`✅ 已加载示例数据，显示${currentData.length}个监测点`);
        }

        /**
         * 解析Excel文件
         */
        function parseExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = () => reject(new Error('文件读取失败'));
                reader.readAsArrayBuffer(file);
            });
        }

        /**
         * 处理Excel数据并转换为地图格式
         */
        function processExcelData(excelData) {
            const processedData = [];
            
            excelData.forEach((row, index) => {
                // 检查必要字段
                if (!row['位置描述'] || !row['信号强度']) {
                    console.warn(`跳过第${index + 1}行：缺少必要字段`);
                    return;
                }

                // 这里暂时使用示例坐标，实际应该调用地理编码API
                // 为简化演示，我们使用南通周边的随机坐标
                const basePosition = [120.863, 32.008];
                const randomOffset = () => (Math.random() - 0.5) * 0.1; // ±0.05度随机偏移
                
                const processed = {
                    name: row['位置描述'],
                    position: [
                        basePosition[0] + randomOffset(),
                        basePosition[1] + randomOffset()
                    ],
                    signal: parseInt(row['信号强度']) || 5,
                    network: row['网络类型'] || '未知',
                    reporter: row['上报人'] || '匿名',
                    time: row['上报时间'] || '未知',
                    note: row['备注'] || '无'
                };

                processedData.push(processed);
            });

            return processedData;
        }

        /**
         * 加载Excel数据
         */
        async function loadExcelData() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('❌ 请先选择Excel文件', 'error');
                return;
            }

            if (!map) {
                showMessage('❌ 请先等待地图加载完成', 'error');
                return;
            }

            try {
                showMessage('📊 正在解析Excel文件...', 'info');
                
                // 解析Excel文件
                const excelData = await parseExcelFile(file);
                console.log('Excel数据:', excelData);

                // 处理数据
                const processedData = processExcelData(excelData);
                
                if (processedData.length === 0) {
                    showMessage('❌ 未找到有效的数据行', 'error');
                    return;
                }

                // 更新当前数据并显示在地图上
                currentData = processedData;
                addSignalMarkers(currentData);
                
                showMessage(`✅ 成功导入 ${processedData.length} 条数据记录`);

            } catch (error) {
                console.error('Excel处理错误:', error);
                showMessage(`❌ Excel文件处理失败: ${error.message}`, 'error');
            }
        }

        /**
         * 初始化控制面板
         */
        function initControls() {
            console.log('🎛️ 初始化控制面板...');
            
            // 热力图开关
            const heatmapSwitch = document.getElementById('heatmapSwitch');
            if (heatmapSwitch) {
                heatmapSwitch.addEventListener('change', function() {
                    console.log('热力图开关状态:', this.checked);
                    if (this.checked) {
                        showHeatmap();
                    } else {
                        hideHeatmap();
                    }
                });
                console.log('✅ 热力图开关事件绑定成功');
            } else {
                console.error('❌ 找不到热力图开关元素');
            }

            // 标记点开关
            const markersSwitch = document.getElementById('markersSwitch');
            if (markersSwitch) {
                markersSwitch.addEventListener('change', function() {
                    console.log('标记点开关状态:', this.checked);
                    if (this.checked) {
                        showMarkers();
                    } else {
                        hideMarkers();
                    }
                });
                console.log('✅ 标记点开关事件绑定成功');
            } else {
                console.error('❌ 找不到标记点开关元素');
            }

            // 强度滑块
            const intensitySlider = document.getElementById('intensitySlider');
            const intensityValue = document.getElementById('intensityValue');
            
            if (intensitySlider && intensityValue) {
                // 设置初始值
                intensityValue.textContent = intensitySlider.value;
                
                intensitySlider.addEventListener('input', function() {
                    intensityValue.textContent = this.value;
                    // 只有在有数据时才进行筛选
                    if (currentData && currentData.length > 0) {
                        filterByIntensity(parseInt(this.value));
                    }
                });
                console.log('✅ 强度滑块事件绑定成功，初始值:', intensitySlider.value);
            } else {
                console.error('❌ 找不到强度滑块元素');
            }
        }

        /**
         * 生成基于监测点聚合的分区热力图数据
         * 将附近的监测点聚合成一个个热力区域
         */
        function generateHeatmapData(data) {
            const heatData = [];
            
            console.log('🗺️ 生成分区聚合热力图...');
            
            // 先将监测点按距离聚合成群组
            const clusters = clusterNearbyPoints(data, 0.15); // 15公里内的点聚合为一组，减少孤立点
            
            console.log(`📊 将${data.length}个监测点聚合为${clusters.length}个热力区域`);
            
            // 为每个群组生成一个热力区域
            clusters.forEach((cluster, index) => {
                const clusterCenter = calculateClusterCenter(cluster);
                const avgSignal = calculateAverageSignal(cluster);
                const clusterSize = cluster.length;
                
                console.log(`🔥 区域${index + 1}: ${clusterSize}个监测点, 平均信号${avgSignal.toFixed(1)}, 中心位置[${clusterCenter[0].toFixed(3)}, ${clusterCenter[1].toFixed(3)}]`);
                
                // 为该群组生成一个热力区域
                const clusterHeatPoints = generateClusterHeatArea(
                    clusterCenter[0], 
                    clusterCenter[1], 
                    avgSignal,
                    clusterSize
                );
                
                heatData.push(...clusterHeatPoints);
            });
            
            console.log(`🔥 生成${heatData.length}个热力点，形成${clusters.length}个独立的热力区域`);
            return heatData;
        }
        
        /**
         * 将附近的监测点聚合成群组
         * 使用简单的距离聚合算法
         */
        function clusterNearbyPoints(data, maxDistance) {
            const clusters = [];
            const used = new Set();
            
            data.forEach((point, index) => {
                if (used.has(index)) return;
                
                // 创建新的群组
                const cluster = [point];
                used.add(index);
                
                // 查找附近的点加入群组
                data.forEach((otherPoint, otherIndex) => {
                    if (used.has(otherIndex)) return;
                    
                    const distance = calculateDistance(point.position, otherPoint.position);
                    if (distance <= maxDistance) {
                        cluster.push(otherPoint);
                        used.add(otherIndex);
                    }
                });
                
                clusters.push(cluster);
            });
            
            return clusters;
        }
        
        /**
         * 计算两点间距离
         */
        function calculateDistance(pos1, pos2) {
            return Math.sqrt(
                Math.pow(pos1[0] - pos2[0], 2) + 
                Math.pow(pos1[1] - pos2[1], 2)
            );
        }
        
        /**
         * 计算群组中心点
         */
        function calculateClusterCenter(cluster) {
            const sumLng = cluster.reduce((sum, point) => sum + point.position[0], 0);
            const sumLat = cluster.reduce((sum, point) => sum + point.position[1], 0);
            return [sumLng / cluster.length, sumLat / cluster.length];
        }
        
        /**
         * 计算群组平均信号强度
         */
        function calculateAverageSignal(cluster) {
            const sumSignal = cluster.reduce((sum, point) => sum + point.signal, 0);
            return sumSignal / cluster.length;
        }
        
        /**
         * 为一个监测点群组生成热力区域
         */
        function generateClusterHeatArea(centerLng, centerLat, avgSignal, clusterSize) {
            const points = [];
            
            // 根据群组大小和信号强度确定热力区域参数
            const baseRadius = 0.03 + (clusterSize - 1) * 0.01; // 群组越大，热力区域越大
            const heatRadius = baseRadius * (1 + (10 - avgSignal) * 0.2); // 信号越差，影响范围越大
            
            // 信号强度和群组大小转换为热力值
            const baseHeatValue = Math.max(40, (11 - avgSignal) * 25);
            const sizeMultiplier = Math.min(3, 1 + clusterSize * 0.1); // 群组大小影响热力强度
            const centerHeatValue = baseHeatValue * sizeMultiplier;
            
            // 生成不规则的热力区域（模拟真实的信号覆盖范围）
            const layers = 6; // 6层
            const basePointsPerLayer = 8; // 基础每层8个点
            
            // 中心点
            points.push({
                lng: centerLng,
                lat: centerLat,
                count: centerHeatValue
            });
            
            // 生成不规则的热力区域
            for (let layer = 1; layer <= layers; layer++) {
                const layerRadius = (heatRadius * layer) / layers;
                const layerHeatValue = centerHeatValue * Math.pow(0.75, layer);
                const pointsInLayer = basePointsPerLayer + Math.floor(layer * 2); // 外层点更多
                
                for (let i = 0; i < pointsInLayer; i++) {
                    const angle = (i * 2 * Math.PI) / pointsInLayer;
                    
                    // 添加更多随机偏移，形成不规则边界
                    const radiusVariation = 0.3 + Math.random() * 0.4; // 0.3-0.7的变化
                    const actualRadius = layerRadius * radiusVariation;
                    
                    // 角度也添加随机偏移
                    const angleOffset = (Math.random() - 0.5) * 0.5;
                    const actualAngle = angle + angleOffset;
                    
                    const lng = centerLng + actualRadius * Math.cos(actualAngle);
                    const lat = centerLat + actualRadius * Math.sin(actualAngle);
                    
                    points.push({
                        lng: lng,
                        lat: lat,
                        count: Math.max(15, layerHeatValue)
                    });
                }
            }
            
            return points;
        }

        /**
         * 显示热力图
         */
        function showHeatmap() {
            console.log('🔥 开始显示热力图...');
            
            if (!currentData || currentData.length === 0) {
                showMessage('❌ 请先导入数据', 'error');
                document.getElementById('heatmapSwitch').checked = false;
                return;
            }

            if (heatmapLayer) {
                console.log('清除现有热力图...');
                hideHeatmap();
            }

            try {
                // 检查AMap.HeatMap是否可用
                if (typeof AMap === 'undefined' || !AMap.HeatMap) {
                    throw new Error('高德地图热力图插件未加载');
                }

                const heatData = generateHeatmapData(currentData);
                console.log('热力图数据:', heatData);
                
                heatmapLayer = new AMap.HeatMap(map, {
                    radius: 50, // 中等半径适合聚合区域
                    opacity: [0.4, 0.8], // 增加透明度让区域更明显
                    gradient: {
                        '0.0': '#0066ff',  // 信号好 - 深蓝色
                        '0.2': '#0088ff',  // 信号较好 - 蓝色
                        '0.4': '#00ff88',  // 信号一般 - 绿色
                        '0.6': '#ffff00',  // 信号较差 - 黄色  
                        '0.8': '#ff8800',  // 信号差 - 橙色
                        '1.0': '#ff0000'   // 信号盲区 - 红色
                    },
                    blur: 0.7, // 适度模糊保持区域边界清晰
                    max: 400   // 设置最大热力值适应聚合数据
                });
                
                // 计算数据中的最大权重值
                const maxWeight = Math.max(...heatData.map(item => item.count));
                console.log('热力图最大权重值:', maxWeight);
                
                heatmapLayer.setDataSet({
                    data: heatData,
                    max: maxWeight || 100 // 使用实际最大值或默认100
                });

                console.log('✅ 热力图显示成功');
                showMessage('🔥 热力图已开启，红色区域为信号盲区');
                
            } catch (error) {
                console.error('❌ 热力图显示失败:', error);
                showMessage(`❌ 热力图显示失败: ${error.message}`, 'error');
                document.getElementById('heatmapSwitch').checked = false;
            }
        }

        /**
         * 隐藏热力图
         */
        function hideHeatmap() {
            console.log('🌫️ 隐藏热力图...');
            if (heatmapLayer) {
                try {
                    heatmapLayer.hide();
                    heatmapLayer.setMap(null);
                    heatmapLayer = null;
                    console.log('✅ 热力图已隐藏');
                    showMessage('✅ 热力图已关闭');
                } catch (error) {
                    console.error('隐藏热力图失败:', error);
                }
            } else {
                console.log('热力图不存在，无需隐藏');
            }
        }

        /**
         * 显示标记点
         */
        function showMarkers() {
            console.log('📍 显示标记点...');
            if (markers.length > 0) {
                markers.forEach(marker => {
                    marker.show();
                });
                console.log('✅ 标记点已显示');
                showMessage('📍 标记点已显示');
            }
        }

        /**
         * 隐藏标记点
         */
        function hideMarkers() {
            console.log('📍 隐藏标记点...');
            if (markers.length > 0) {
                markers.forEach(marker => {
                    marker.hide();
                });
                console.log('✅ 标记点已隐藏');
                showMessage('📍 标记点已隐藏');
            }
        }

        /**
         * 根据信号强度筛选显示
         */
        function filterByIntensity(maxIntensity) {
            if (!currentData || currentData.length === 0) return;
            
            // 筛选数据
            const filteredData = currentData.filter(point => point.signal <= maxIntensity);
            
            // 清除现有标记
            clearMarkers();
            
            // 重新添加符合条件的标记 (使用筛选后的数据，但不改变currentData)
            const displayData = filteredData;
            
            // 采样显示逻辑 (从addSignalMarkers函数复制过来)
            let finalDisplayData = displayData;
            const MAX_MARKERS = 200;
            
            if (displayData.length > MAX_MARKERS) {
                const severeBlinds = displayData.filter(p => p.signal <= 2);
                const poor = displayData.filter(p => p.signal >= 3 && p.signal <= 4);
                const normal = displayData.filter(p => p.signal >= 5 && p.signal <= 6);
                const good = displayData.filter(p => p.signal >= 7);
                
                const sampleSize = Math.floor(MAX_MARKERS / 4);
                finalDisplayData = [
                    ...sampleArray(severeBlinds, sampleSize),
                    ...sampleArray(poor, sampleSize),
                    ...sampleArray(normal, sampleSize),
                    ...sampleArray(good, sampleSize)
                ];
            }
            
            // 添加标记
            finalDisplayData.forEach((point, index) => {
                const iconConfig = getIconConfig(point.signal);
                const icon = createMarkerIcon(iconConfig.color, iconConfig.size);
                
                const marker = new AMap.Marker({
                    position: point.position,
                    title: `${point.name} - 信号强度: ${point.signal}/10 (${getSignalDescription(point.signal)})`,
                    icon: icon
                });

                map.add(marker);
                markers.push(marker);
            });
            
            // 更新信息面板
            updateInfoPanel(filteredData);
            
            // 更新热力图 (如果开启了热力图)
            if (heatmapLayer) {
                hideHeatmap();
                setTimeout(() => {
                    const originalData = currentData; // 保存原始数据
                    currentData = filteredData; // 临时设置为筛选数据
                    showHeatmap();
                    currentData = originalData; // 恢复原始数据
                }, 100);
            }
            
            showMessage(`🔍 显示信号强度 ≤ ${maxIntensity} 的监测点 (${filteredData.length} 个)`);
        }

        /**
         * 更新热力图 (数据变化时调用)
         */
        function updateHeatmap() {
            const heatmapSwitch = document.getElementById('heatmapSwitch');
            if (heatmapSwitch && heatmapSwitch.checked) {
                hideHeatmap();
                setTimeout(showHeatmap, 100);
            }
        }

        /**
         * 测试热力图功能
         */
        function testHeatmap() {
            console.log('🧪 测试热力图功能...');
            console.log('AMap对象:', typeof AMap);
            console.log('AMap.HeatMap对象:', typeof AMap.HeatMap);
            console.log('地图对象:', map);
            console.log('当前数据:', currentData);
            console.log('热力图层:', heatmapLayer);
            
            const heatmapSwitch = document.getElementById('heatmapSwitch');
            console.log('热力图开关元素:', heatmapSwitch);
            console.log('开关状态:', heatmapSwitch ? heatmapSwitch.checked : '元素不存在');
            
            // 手动测试热力图开关
            if (heatmapSwitch) {
                console.log('点击开关进行测试...');
                heatmapSwitch.click();
            }
        }

        /**
         * 手动触发热力图显示（调试用）
         */
        function manualShowHeatmap() {
            console.log('🔥 手动触发热力图显示...');
            if (currentData.length === 0) {
                useDefaultData();
                setTimeout(() => {
                    showHeatmap();
                }, 1000);
            } else {
                showHeatmap();
            }
        }

        /**
         * 手动触发热力图隐藏（调试用）
         */
        function manualHideHeatmap() {
            console.log('🌫️ 手动触发热力图隐藏...');
            hideHeatmap();
        }

        // 页面加载完成后初始化地图
        window.onload = function() {
            console.log('🚀 页面加载完成，开始初始化...');
            initMap();
            
            // 5秒后测试热力图功能（给地图时间加载）
            setTimeout(testHeatmap, 5000);
        };
    </script>
</body>
</html> 